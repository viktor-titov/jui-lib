// Copyright (c) 2017 Uber Technologies, Inc.
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
// http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

import traceGenerator from '../demo/trace-generators';
import { findServerChildSpan, createViewedBoundsFunc, isClientSpan, isErrorSpan, isServerSpan, spanContainsErredSpan, spanHasTag } from './utils';
describe('TraceTimelineViewer/utils', function () {
  describe('getViewedBounds()', function () {
    it('works for the full range', function () {
      var args = {
        min: 1,
        max: 2,
        viewStart: 0,
        viewEnd: 1
      };
      var _createViewedBoundsFu = createViewedBoundsFunc(args)(1, 2),
        start = _createViewedBoundsFu.start,
        end = _createViewedBoundsFu.end;
      expect(start).toBe(0);
      expect(end).toBe(1);
    });
    it('works for a sub-range with a full view', function () {
      var args = {
        min: 1,
        max: 2,
        viewStart: 0,
        viewEnd: 1
      };
      var _createViewedBoundsFu2 = createViewedBoundsFunc(args)(1.25, 1.75),
        start = _createViewedBoundsFu2.start,
        end = _createViewedBoundsFu2.end;
      expect(start).toBe(0.25);
      expect(end).toBe(0.75);
    });
    it('works for a sub-range that fills the view', function () {
      var args = {
        min: 1,
        max: 2,
        viewStart: 0.25,
        viewEnd: 0.75
      };
      var _createViewedBoundsFu3 = createViewedBoundsFunc(args)(1.25, 1.75),
        start = _createViewedBoundsFu3.start,
        end = _createViewedBoundsFu3.end;
      expect(start).toBe(0);
      expect(end).toBe(1);
    });
    it('works for a sub-range that within a sub-view', function () {
      var args = {
        min: 100,
        max: 200,
        viewStart: 0.1,
        viewEnd: 0.9
      };
      var _createViewedBoundsFu4 = createViewedBoundsFunc(args)(130, 170),
        start = _createViewedBoundsFu4.start,
        end = _createViewedBoundsFu4.end;
      expect(start).toBe(0.25);
      expect(end).toBe(0.75);
    });
  });
  describe('spanHasTag() and variants', function () {
    it('returns true iff the key/value pair is found', function () {
      var span = traceGenerator.span;
      span.tags = [{
        key: 'span.kind',
        value: 'server'
      }];
      expect(spanHasTag('span.kind', 'client', span)).toBe(false);
      expect(spanHasTag('span.kind', 'client', span)).toBe(false);
      expect(spanHasTag('span.kind', 'server', span)).toBe(true);
    });
    var spanTypeTestCases = [{
      fn: isClientSpan,
      name: 'isClientSpan',
      key: 'span.kind',
      value: 'client'
    }, {
      fn: isServerSpan,
      name: 'isServerSpan',
      key: 'span.kind',
      value: 'server'
    }, {
      fn: isErrorSpan,
      name: 'isErrorSpan',
      key: 'error',
      value: true
    }, {
      fn: isErrorSpan,
      name: 'isErrorSpan',
      key: 'error',
      value: 'true'
    }];
    spanTypeTestCases.forEach(function (testCase) {
      var msg = testCase.name + "() is true only when a " + testCase.key + "=" + testCase.value + " tag is present";
      it(msg, function () {
        var span = {
          tags: traceGenerator.tags()
        };
        expect(testCase.fn(span)).toBe(false);
        span.tags.push(testCase);
        expect(testCase.fn(span)).toBe(true);
      });
    });
  });
  describe('spanContainsErredSpan()', function () {
    it('returns true only when a descendant has an error tag', function () {
      var errorTag = {
        key: 'error',
        type: 'bool',
        value: true
      };
      var getTags = function getTags(withError) {
        return withError ? traceGenerator.tags().concat(errorTag) : traceGenerator.tags();
      };

      // Using a string to generate the test spans. Each line results in a span. The
      // left number indicates whether or not the generated span has a descendant
      // with an error tag (the expectation). The length of the line indicates the
      // depth of the span (i.e. further right is higher depth). The right number
      // indicates whether or not the span has an error tag.
      var config = "\n        1   0\n        1     0\n        0       1\n        0     0\n        1     0\n        1       1\n        0         1\n        0           0\n        1         0\n        0           1\n        0   0\n      ".trim().split('\n').map(function (s) {
        return s.trim();
      });
      // Get the expectation, str -> number -> bool
      var expectations = config.map(function (s) {
        return Boolean(Number(s[0]));
      });
      var spans = config.map(function (line) {
        return {
          depth: line.length,
          tags: getTags(+line.slice(-1))
        };
      });
      expectations.forEach(function (target, i) {
        // include the index in the expect condition to know which span failed
        // (if there is a failure, that is)
        var result = [i, spanContainsErredSpan(spans, i)];
        expect(result).toEqual([i, target]);
      });
    });
  });
  describe('findServerChildSpan()', function () {
    var spans;
    beforeEach(function () {
      spans = [{
        depth: 0,
        tags: [{
          key: 'span.kind',
          value: 'client'
        }]
      }, {
        depth: 1,
        tags: []
      }, {
        depth: 1,
        tags: [{
          key: 'span.kind',
          value: 'server'
        }]
      }, {
        depth: 1,
        tags: [{
          key: 'span.kind',
          value: 'third-kind'
        }]
      }, {
        depth: 1,
        tags: [{
          key: 'span.kind',
          value: 'server'
        }]
      }];
    });
    it('returns falsy if the frist span is not a client', function () {
      expect(findServerChildSpan(spans.slice(1))).toBeFalsy();
    });
    it('returns the first server span', function () {
      var span = findServerChildSpan(spans);
      expect(span).toBe(spans[2]);
    });
    it('bails when a non-child-depth span is encountered', function () {
      spans[1].depth++;
      expect(findServerChildSpan(spans)).toBeFalsy();
      spans[1].depth = spans[0].depth;
      expect(findServerChildSpan(spans)).toBeFalsy();
    });
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJ0cmFjZUdlbmVyYXRvciIsImZpbmRTZXJ2ZXJDaGlsZFNwYW4iLCJjcmVhdGVWaWV3ZWRCb3VuZHNGdW5jIiwiaXNDbGllbnRTcGFuIiwiaXNFcnJvclNwYW4iLCJpc1NlcnZlclNwYW4iLCJzcGFuQ29udGFpbnNFcnJlZFNwYW4iLCJzcGFuSGFzVGFnIiwiZGVzY3JpYmUiLCJpdCIsImFyZ3MiLCJtaW4iLCJtYXgiLCJ2aWV3U3RhcnQiLCJ2aWV3RW5kIiwiX2NyZWF0ZVZpZXdlZEJvdW5kc0Z1Iiwic3RhcnQiLCJlbmQiLCJleHBlY3QiLCJ0b0JlIiwiX2NyZWF0ZVZpZXdlZEJvdW5kc0Z1MiIsIl9jcmVhdGVWaWV3ZWRCb3VuZHNGdTMiLCJfY3JlYXRlVmlld2VkQm91bmRzRnU0Iiwic3BhbiIsInRhZ3MiLCJrZXkiLCJ2YWx1ZSIsInNwYW5UeXBlVGVzdENhc2VzIiwiZm4iLCJuYW1lIiwiZm9yRWFjaCIsInRlc3RDYXNlIiwibXNnIiwicHVzaCIsImVycm9yVGFnIiwidHlwZSIsImdldFRhZ3MiLCJ3aXRoRXJyb3IiLCJjb25jYXQiLCJjb25maWciLCJ0cmltIiwic3BsaXQiLCJtYXAiLCJzIiwiZXhwZWN0YXRpb25zIiwiQm9vbGVhbiIsIk51bWJlciIsInNwYW5zIiwibGluZSIsImRlcHRoIiwibGVuZ3RoIiwic2xpY2UiLCJ0YXJnZXQiLCJpIiwicmVzdWx0IiwidG9FcXVhbCIsImJlZm9yZUVhY2giLCJ0b0JlRmFsc3kiXSwic291cmNlcyI6WyIuLi8uLi9zcmMvVHJhY2VUaW1lbGluZVZpZXdlci91dGlscy50ZXN0LnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAoYykgMjAxNyBVYmVyIFRlY2hub2xvZ2llcywgSW5jLlxuLy9cbi8vIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG4vLyB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4vLyBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbi8vXG4vLyBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbi8vXG4vLyBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4vLyBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG4vLyBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cbi8vIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbi8vIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuXG5pbXBvcnQgeyBUcmFjZVNwYW4gfSBmcm9tICcuLi90eXBlcy90cmFjZSc7XG5cbmltcG9ydCB0cmFjZUdlbmVyYXRvciBmcm9tICcuLi9kZW1vL3RyYWNlLWdlbmVyYXRvcnMnO1xuXG5pbXBvcnQge1xuICBmaW5kU2VydmVyQ2hpbGRTcGFuLFxuICBjcmVhdGVWaWV3ZWRCb3VuZHNGdW5jLFxuICBpc0NsaWVudFNwYW4sXG4gIGlzRXJyb3JTcGFuLFxuICBpc1NlcnZlclNwYW4sXG4gIHNwYW5Db250YWluc0VycmVkU3BhbixcbiAgc3Bhbkhhc1RhZyxcbn0gZnJvbSAnLi91dGlscyc7XG5cbmRlc2NyaWJlKCdUcmFjZVRpbWVsaW5lVmlld2VyL3V0aWxzJywgKCkgPT4ge1xuICBkZXNjcmliZSgnZ2V0Vmlld2VkQm91bmRzKCknLCAoKSA9PiB7XG4gICAgaXQoJ3dvcmtzIGZvciB0aGUgZnVsbCByYW5nZScsICgpID0+IHtcbiAgICAgIGNvbnN0IGFyZ3MgPSB7IG1pbjogMSwgbWF4OiAyLCB2aWV3U3RhcnQ6IDAsIHZpZXdFbmQ6IDEgfTtcbiAgICAgIGNvbnN0IHsgc3RhcnQsIGVuZCB9ID0gY3JlYXRlVmlld2VkQm91bmRzRnVuYyhhcmdzKSgxLCAyKTtcbiAgICAgIGV4cGVjdChzdGFydCkudG9CZSgwKTtcbiAgICAgIGV4cGVjdChlbmQpLnRvQmUoMSk7XG4gICAgfSk7XG5cbiAgICBpdCgnd29ya3MgZm9yIGEgc3ViLXJhbmdlIHdpdGggYSBmdWxsIHZpZXcnLCAoKSA9PiB7XG4gICAgICBjb25zdCBhcmdzID0geyBtaW46IDEsIG1heDogMiwgdmlld1N0YXJ0OiAwLCB2aWV3RW5kOiAxIH07XG4gICAgICBjb25zdCB7IHN0YXJ0LCBlbmQgfSA9IGNyZWF0ZVZpZXdlZEJvdW5kc0Z1bmMoYXJncykoMS4yNSwgMS43NSk7XG4gICAgICBleHBlY3Qoc3RhcnQpLnRvQmUoMC4yNSk7XG4gICAgICBleHBlY3QoZW5kKS50b0JlKDAuNzUpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3dvcmtzIGZvciBhIHN1Yi1yYW5nZSB0aGF0IGZpbGxzIHRoZSB2aWV3JywgKCkgPT4ge1xuICAgICAgY29uc3QgYXJncyA9IHsgbWluOiAxLCBtYXg6IDIsIHZpZXdTdGFydDogMC4yNSwgdmlld0VuZDogMC43NSB9O1xuICAgICAgY29uc3QgeyBzdGFydCwgZW5kIH0gPSBjcmVhdGVWaWV3ZWRCb3VuZHNGdW5jKGFyZ3MpKDEuMjUsIDEuNzUpO1xuICAgICAgZXhwZWN0KHN0YXJ0KS50b0JlKDApO1xuICAgICAgZXhwZWN0KGVuZCkudG9CZSgxKTtcbiAgICB9KTtcblxuICAgIGl0KCd3b3JrcyBmb3IgYSBzdWItcmFuZ2UgdGhhdCB3aXRoaW4gYSBzdWItdmlldycsICgpID0+IHtcbiAgICAgIGNvbnN0IGFyZ3MgPSB7IG1pbjogMTAwLCBtYXg6IDIwMCwgdmlld1N0YXJ0OiAwLjEsIHZpZXdFbmQ6IDAuOSB9O1xuICAgICAgY29uc3QgeyBzdGFydCwgZW5kIH0gPSBjcmVhdGVWaWV3ZWRCb3VuZHNGdW5jKGFyZ3MpKDEzMCwgMTcwKTtcbiAgICAgIGV4cGVjdChzdGFydCkudG9CZSgwLjI1KTtcbiAgICAgIGV4cGVjdChlbmQpLnRvQmUoMC43NSk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdzcGFuSGFzVGFnKCkgYW5kIHZhcmlhbnRzJywgKCkgPT4ge1xuICAgIGl0KCdyZXR1cm5zIHRydWUgaWZmIHRoZSBrZXkvdmFsdWUgcGFpciBpcyBmb3VuZCcsICgpID0+IHtcbiAgICAgIGNvbnN0IHNwYW4gPSB0cmFjZUdlbmVyYXRvci5zcGFuO1xuICAgICAgc3Bhbi50YWdzID0gW3sga2V5OiAnc3Bhbi5raW5kJywgdmFsdWU6ICdzZXJ2ZXInIH1dO1xuICAgICAgZXhwZWN0KHNwYW5IYXNUYWcoJ3NwYW4ua2luZCcsICdjbGllbnQnLCBzcGFuKSkudG9CZShmYWxzZSk7XG4gICAgICBleHBlY3Qoc3Bhbkhhc1RhZygnc3Bhbi5raW5kJywgJ2NsaWVudCcsIHNwYW4pKS50b0JlKGZhbHNlKTtcbiAgICAgIGV4cGVjdChzcGFuSGFzVGFnKCdzcGFuLmtpbmQnLCAnc2VydmVyJywgc3BhbikpLnRvQmUodHJ1ZSk7XG4gICAgfSk7XG5cbiAgICBjb25zdCBzcGFuVHlwZVRlc3RDYXNlcyA9IFtcbiAgICAgIHsgZm46IGlzQ2xpZW50U3BhbiwgbmFtZTogJ2lzQ2xpZW50U3BhbicsIGtleTogJ3NwYW4ua2luZCcsIHZhbHVlOiAnY2xpZW50JyB9LFxuICAgICAgeyBmbjogaXNTZXJ2ZXJTcGFuLCBuYW1lOiAnaXNTZXJ2ZXJTcGFuJywga2V5OiAnc3Bhbi5raW5kJywgdmFsdWU6ICdzZXJ2ZXInIH0sXG4gICAgICB7IGZuOiBpc0Vycm9yU3BhbiwgbmFtZTogJ2lzRXJyb3JTcGFuJywga2V5OiAnZXJyb3InLCB2YWx1ZTogdHJ1ZSB9LFxuICAgICAgeyBmbjogaXNFcnJvclNwYW4sIG5hbWU6ICdpc0Vycm9yU3BhbicsIGtleTogJ2Vycm9yJywgdmFsdWU6ICd0cnVlJyB9LFxuICAgIF07XG5cbiAgICBzcGFuVHlwZVRlc3RDYXNlcy5mb3JFYWNoKCh0ZXN0Q2FzZSkgPT4ge1xuICAgICAgY29uc3QgbXNnID0gYCR7dGVzdENhc2UubmFtZX0oKSBpcyB0cnVlIG9ubHkgd2hlbiBhICR7dGVzdENhc2Uua2V5fT0ke3Rlc3RDYXNlLnZhbHVlfSB0YWcgaXMgcHJlc2VudGA7XG4gICAgICBpdChtc2csICgpID0+IHtcbiAgICAgICAgY29uc3Qgc3BhbiA9IHsgdGFnczogdHJhY2VHZW5lcmF0b3IudGFncygpIH0gYXMgVHJhY2VTcGFuO1xuICAgICAgICBleHBlY3QodGVzdENhc2UuZm4oc3BhbikpLnRvQmUoZmFsc2UpO1xuICAgICAgICBzcGFuLnRhZ3MucHVzaCh0ZXN0Q2FzZSk7XG4gICAgICAgIGV4cGVjdCh0ZXN0Q2FzZS5mbihzcGFuKSkudG9CZSh0cnVlKTtcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnc3BhbkNvbnRhaW5zRXJyZWRTcGFuKCknLCAoKSA9PiB7XG4gICAgaXQoJ3JldHVybnMgdHJ1ZSBvbmx5IHdoZW4gYSBkZXNjZW5kYW50IGhhcyBhbiBlcnJvciB0YWcnLCAoKSA9PiB7XG4gICAgICBjb25zdCBlcnJvclRhZyA9IHsga2V5OiAnZXJyb3InLCB0eXBlOiAnYm9vbCcsIHZhbHVlOiB0cnVlIH07XG4gICAgICBjb25zdCBnZXRUYWdzID0gKHdpdGhFcnJvcjogbnVtYmVyKSA9PlxuICAgICAgICB3aXRoRXJyb3IgPyB0cmFjZUdlbmVyYXRvci50YWdzKCkuY29uY2F0KGVycm9yVGFnKSA6IHRyYWNlR2VuZXJhdG9yLnRhZ3MoKTtcblxuICAgICAgLy8gVXNpbmcgYSBzdHJpbmcgdG8gZ2VuZXJhdGUgdGhlIHRlc3Qgc3BhbnMuIEVhY2ggbGluZSByZXN1bHRzIGluIGEgc3Bhbi4gVGhlXG4gICAgICAvLyBsZWZ0IG51bWJlciBpbmRpY2F0ZXMgd2hldGhlciBvciBub3QgdGhlIGdlbmVyYXRlZCBzcGFuIGhhcyBhIGRlc2NlbmRhbnRcbiAgICAgIC8vIHdpdGggYW4gZXJyb3IgdGFnICh0aGUgZXhwZWN0YXRpb24pLiBUaGUgbGVuZ3RoIG9mIHRoZSBsaW5lIGluZGljYXRlcyB0aGVcbiAgICAgIC8vIGRlcHRoIG9mIHRoZSBzcGFuIChpLmUuIGZ1cnRoZXIgcmlnaHQgaXMgaGlnaGVyIGRlcHRoKS4gVGhlIHJpZ2h0IG51bWJlclxuICAgICAgLy8gaW5kaWNhdGVzIHdoZXRoZXIgb3Igbm90IHRoZSBzcGFuIGhhcyBhbiBlcnJvciB0YWcuXG4gICAgICBjb25zdCBjb25maWcgPSBgXG4gICAgICAgIDEgICAwXG4gICAgICAgIDEgICAgIDBcbiAgICAgICAgMCAgICAgICAxXG4gICAgICAgIDAgICAgIDBcbiAgICAgICAgMSAgICAgMFxuICAgICAgICAxICAgICAgIDFcbiAgICAgICAgMCAgICAgICAgIDFcbiAgICAgICAgMCAgICAgICAgICAgMFxuICAgICAgICAxICAgICAgICAgMFxuICAgICAgICAwICAgICAgICAgICAxXG4gICAgICAgIDAgICAwXG4gICAgICBgXG4gICAgICAgIC50cmltKClcbiAgICAgICAgLnNwbGl0KCdcXG4nKVxuICAgICAgICAubWFwKChzKSA9PiBzLnRyaW0oKSk7XG4gICAgICAvLyBHZXQgdGhlIGV4cGVjdGF0aW9uLCBzdHIgLT4gbnVtYmVyIC0+IGJvb2xcbiAgICAgIGNvbnN0IGV4cGVjdGF0aW9ucyA9IGNvbmZpZy5tYXAoKHMpID0+IEJvb2xlYW4oTnVtYmVyKHNbMF0pKSk7XG4gICAgICBjb25zdCBzcGFucyA9IGNvbmZpZy5tYXAoKGxpbmUpID0+ICh7XG4gICAgICAgIGRlcHRoOiBsaW5lLmxlbmd0aCxcbiAgICAgICAgdGFnczogZ2V0VGFncygrbGluZS5zbGljZSgtMSkpLFxuICAgICAgfSkpIGFzIFRyYWNlU3BhbltdO1xuXG4gICAgICBleHBlY3RhdGlvbnMuZm9yRWFjaCgodGFyZ2V0LCBpKSA9PiB7XG4gICAgICAgIC8vIGluY2x1ZGUgdGhlIGluZGV4IGluIHRoZSBleHBlY3QgY29uZGl0aW9uIHRvIGtub3cgd2hpY2ggc3BhbiBmYWlsZWRcbiAgICAgICAgLy8gKGlmIHRoZXJlIGlzIGEgZmFpbHVyZSwgdGhhdCBpcylcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gW2ksIHNwYW5Db250YWluc0VycmVkU3BhbihzcGFucywgaSldO1xuICAgICAgICBleHBlY3QocmVzdWx0KS50b0VxdWFsKFtpLCB0YXJnZXRdKTtcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnZmluZFNlcnZlckNoaWxkU3BhbigpJywgKCkgPT4ge1xuICAgIGxldCBzcGFuczogVHJhY2VTcGFuW107XG5cbiAgICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICAgIHNwYW5zID0gW1xuICAgICAgICB7IGRlcHRoOiAwLCB0YWdzOiBbeyBrZXk6ICdzcGFuLmtpbmQnLCB2YWx1ZTogJ2NsaWVudCcgfV0gfSxcbiAgICAgICAgeyBkZXB0aDogMSwgdGFnczogW10gfSxcbiAgICAgICAgeyBkZXB0aDogMSwgdGFnczogW3sga2V5OiAnc3Bhbi5raW5kJywgdmFsdWU6ICdzZXJ2ZXInIH1dIH0sXG4gICAgICAgIHsgZGVwdGg6IDEsIHRhZ3M6IFt7IGtleTogJ3NwYW4ua2luZCcsIHZhbHVlOiAndGhpcmQta2luZCcgfV0gfSxcbiAgICAgICAgeyBkZXB0aDogMSwgdGFnczogW3sga2V5OiAnc3Bhbi5raW5kJywgdmFsdWU6ICdzZXJ2ZXInIH1dIH0sXG4gICAgICBdIGFzIFRyYWNlU3BhbltdO1xuICAgIH0pO1xuXG4gICAgaXQoJ3JldHVybnMgZmFsc3kgaWYgdGhlIGZyaXN0IHNwYW4gaXMgbm90IGEgY2xpZW50JywgKCkgPT4ge1xuICAgICAgZXhwZWN0KGZpbmRTZXJ2ZXJDaGlsZFNwYW4oc3BhbnMuc2xpY2UoMSkpKS50b0JlRmFsc3koKTtcbiAgICB9KTtcblxuICAgIGl0KCdyZXR1cm5zIHRoZSBmaXJzdCBzZXJ2ZXIgc3BhbicsICgpID0+IHtcbiAgICAgIGNvbnN0IHNwYW4gPSBmaW5kU2VydmVyQ2hpbGRTcGFuKHNwYW5zKTtcbiAgICAgIGV4cGVjdChzcGFuKS50b0JlKHNwYW5zWzJdKTtcbiAgICB9KTtcblxuICAgIGl0KCdiYWlscyB3aGVuIGEgbm9uLWNoaWxkLWRlcHRoIHNwYW4gaXMgZW5jb3VudGVyZWQnLCAoKSA9PiB7XG4gICAgICBzcGFuc1sxXS5kZXB0aCsrO1xuICAgICAgZXhwZWN0KGZpbmRTZXJ2ZXJDaGlsZFNwYW4oc3BhbnMpKS50b0JlRmFsc3koKTtcbiAgICAgIHNwYW5zWzFdLmRlcHRoID0gc3BhbnNbMF0uZGVwdGg7XG4gICAgICBleHBlY3QoZmluZFNlcnZlckNoaWxkU3BhbihzcGFucykpLnRvQmVGYWxzeSgpO1xuICAgIH0pO1xuICB9KTtcbn0pO1xuIl0sIm1hcHBpbmdzIjoiQUFBQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFJQSxPQUFPQSxjQUFjLE1BQU0sMEJBQTBCO0FBRXJELFNBQ0VDLG1CQUFtQixFQUNuQkMsc0JBQXNCLEVBQ3RCQyxZQUFZLEVBQ1pDLFdBQVcsRUFDWEMsWUFBWSxFQUNaQyxxQkFBcUIsRUFDckJDLFVBQVUsUUFDTCxTQUFTO0FBRWhCQyxRQUFRLENBQUMsMkJBQTJCLEVBQUUsWUFBTTtFQUMxQ0EsUUFBUSxDQUFDLG1CQUFtQixFQUFFLFlBQU07SUFDbENDLEVBQUUsQ0FBQywwQkFBMEIsRUFBRSxZQUFNO01BQ25DLElBQU1DLElBQUksR0FBRztRQUFFQyxHQUFHLEVBQUUsQ0FBQztRQUFFQyxHQUFHLEVBQUUsQ0FBQztRQUFFQyxTQUFTLEVBQUUsQ0FBQztRQUFFQyxPQUFPLEVBQUU7TUFBRSxDQUFDO01BQ3pELElBQUFDLHFCQUFBLEdBQXVCYixzQkFBc0IsQ0FBQ1EsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUFqRE0sS0FBSyxHQUFBRCxxQkFBQSxDQUFMQyxLQUFLO1FBQUVDLEdBQUcsR0FBQUYscUJBQUEsQ0FBSEUsR0FBRztN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