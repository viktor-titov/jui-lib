// Copyright (c) 2017 Uber Technologies, Inc.
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
// http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

import traceGenerator from '../demo/trace-generators';
import { findServerChildSpan, createViewedBoundsFunc, isClientSpan, isErrorSpan, isServerSpan, spanContainsErredSpan, spanHasTag } from './utils';
describe('TraceTimelineViewer/utils', function () {
  describe('getViewedBounds()', function () {
    it('works for the full range', function () {
      var args = {
        min: 1,
        max: 2,
        viewStart: 0,
        viewEnd: 1
      };
      var _createViewedBoundsFu = createViewedBoundsFunc(args)(1, 2),
        start = _createViewedBoundsFu.start,
        end = _createViewedBoundsFu.end;
      expect(start).toBe(0);
      expect(end).toBe(1);
    });
    it('works for a sub-range with a full view', function () {
      var args = {
        min: 1,
        max: 2,
        viewStart: 0,
        viewEnd: 1
      };
      var _createViewedBoundsFu2 = createViewedBoundsFunc(args)(1.25, 1.75),
        start = _createViewedBoundsFu2.start,
        end = _createViewedBoundsFu2.end;
      expect(start).toBe(0.25);
      expect(end).toBe(0.75);
    });
    it('works for a sub-range that fills the view', function () {
      var args = {
        min: 1,
        max: 2,
        viewStart: 0.25,
        viewEnd: 0.75
      };
      var _createViewedBoundsFu3 = createViewedBoundsFunc(args)(1.25, 1.75),
        start = _createViewedBoundsFu3.start,
        end = _createViewedBoundsFu3.end;
      expect(start).toBe(0);
      expect(end).toBe(1);
    });
    it('works for a sub-range that within a sub-view', function () {
      var args = {
        min: 100,
        max: 200,
        viewStart: 0.1,
        viewEnd: 0.9
      };
      var _createViewedBoundsFu4 = createViewedBoundsFunc(args)(130, 170),
        start = _createViewedBoundsFu4.start,
        end = _createViewedBoundsFu4.end;
      expect(start).toBe(0.25);
      expect(end).toBe(0.75);
    });
  });
  describe('spanHasTag() and variants', function () {
    it('returns true iff the key/value pair is found', function () {
      var span = traceGenerator.span;
      span.tags = [{
        key: 'span.kind',
        value: 'server'
      }];
      expect(spanHasTag('span.kind', 'client', span)).toBe(false);
      expect(spanHasTag('span.kind', 'client', span)).toBe(false);
      expect(spanHasTag('span.kind', 'server', span)).toBe(true);
    });
    var spanTypeTestCases = [{
      fn: isClientSpan,
      name: 'isClientSpan',
      key: 'span.kind',
      value: 'client'
    }, {
      fn: isServerSpan,
      name: 'isServerSpan',
      key: 'span.kind',
      value: 'server'
    }, {
      fn: isErrorSpan,
      name: 'isErrorSpan',
      key: 'error',
      value: true
    }, {
      fn: isErrorSpan,
      name: 'isErrorSpan',
      key: 'error',
      value: 'true'
    }];
    spanTypeTestCases.forEach(function (testCase) {
      var msg = testCase.name + "() is true only when a " + testCase.key + "=" + testCase.value + " tag is present";
      it(msg, function () {
        var span = {
          tags: traceGenerator.tags()
        };
        expect(testCase.fn(span)).toBe(false);
        span.tags.push(testCase);
        expect(testCase.fn(span)).toBe(true);
      });
    });
  });
  describe('spanContainsErredSpan()', function () {
    it('returns true only when a descendant has an error tag', function () {
      var errorTag = {
        key: 'error',
        type: 'bool',
        value: true
      };
      var getTags = function getTags(withError) {
        return withError ? traceGenerator.tags().concat(errorTag) : traceGenerator.tags();
      };

      // Using a string to generate the test spans. Each line results in a span. The
      // left number indicates whether or not the generated span has a descendant
      // with an error tag (the expectation). The length of the line indicates the
      // depth of the span (i.e. further right is higher depth). The right number
      // indicates whether or not the span has an error tag.
      var config = "\n        1   0\n        1     0\n        0       1\n        0     0\n        1     0\n        1       1\n        0         1\n        0           0\n        1         0\n        0           1\n        0   0\n      ".trim().split('\n').map(function (s) {
        return s.trim();
      });
      // Get the expectation, str -> number -> bool
      var expectations = config.map(function (s) {
        return Boolean(Number(s[0]));
      });
      var spans = config.map(function (line) {
        return {
          depth: line.length,
          tags: getTags(+line.slice(-1))
        };
      });
      expectations.forEach(function (target, i) {
        // include the index in the expect condition to know which span failed
        // (if there is a failure, that is)
        var result = [i, spanContainsErredSpan(spans, i)];
        expect(result).toEqual([i, target]);
      });
    });
  });
  describe('findServerChildSpan()', function () {
    var spans;
    beforeEach(function () {
      spans = [{
        depth: 0,
        tags: [{
          key: 'span.kind',
          value: 'client'
        }]
      }, {
        depth: 1,
        tags: []
      }, {
        depth: 1,
        tags: [{
          key: 'span.kind',
          value: 'server'
        }]
      }, {
        depth: 1,
        tags: [{
          key: 'span.kind',
          value: 'third-kind'
        }]
      }, {
        depth: 1,
        tags: [{
          key: 'span.kind',
          value: 'server'
        }]
      }];
    });
    it('returns falsy if the frist span is not a client', function () {
      expect(findServerChildSpan(spans.slice(1))).toBeFalsy();
    });
    it('returns the first server span', function () {
      var span = findServerChildSpan(spans);
      expect(span).toBe(spans[2]);
    });
    it('bails when a non-child-depth span is encountered', function () {
      spans[1].depth++;
      expect(findServerChildSpan(spans)).toBeFalsy();
      spans[1].depth = spans[0].depth;
      expect(findServerChildSpan(spans)).toBeFalsy();
    });
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJ0cmFjZUdlbmVyYXRvciIsImZpbmRTZXJ2ZXJDaGlsZFNwYW4iLCJjcmVhdGVWaWV3ZWRCb3VuZHNGdW5jIiwiaXNDbGllbnRTcGFuIiwiaXNFcnJvclNwYW4iLCJpc1NlcnZlclNwYW4iLCJzcGFuQ29udGFpbnNFcnJlZFNwYW4iLCJzcGFuSGFzVGFnIiwiZGVzY3JpYmUiLCJpdCIsImFyZ3MiLCJtaW4iLCJtYXgiLCJ2aWV3U3RhcnQiLCJ2aWV3RW5kIiwiX2NyZWF0ZVZpZXdlZEJvdW5kc0Z1Iiwic3RhcnQiLCJlbmQiLCJleHBlY3QiLCJ0b0JlIiwiX2NyZWF0ZVZpZXdlZEJvdW5kc0Z1MiIsIl9jcmVhdGVWaWV3ZWRCb3VuZHNGdTMiLCJfY3JlYXRlVmlld2VkQm91bmRzRnU0Iiwic3BhbiIsInRhZ3MiLCJrZXkiLCJ2YWx1ZSIsInNwYW5UeXBlVGVzdENhc2VzIiwiZm4iLCJuYW1lIiwiZm9yRWFjaCIsInRlc3RDYXNlIiwibXNnIiwicHVzaCIsImVycm9yVGFnIiwidHlwZSIsImdldFRhZ3MiLCJ3aXRoRXJyb3IiLCJjb25jYXQiLCJjb25maWciLCJ0cmltIiwic3BsaXQiLCJtYXAiLCJzIiwiZXhwZWN0YXRpb25zIiwiQm9vbGVhbiIsIk51bWJlciIsInNwYW5zIiwibGluZSIsImRlcHRoIiwibGVuZ3RoIiwic2xpY2UiLCJ0YXJnZXQiLCJpIiwicmVzdWx0IiwidG9FcXVhbCIsImJlZm9yZUVhY2giLCJ0b0JlRmFsc3kiXSwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvbGliL1RyYWNlVGltZWxpbmVWaWV3ZXIvdXRpbHMudGVzdC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgKGMpIDIwMTcgVWJlciBUZWNobm9sb2dpZXMsIEluYy5cbi8vXG4vLyBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xuLy8geW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuLy8gWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4vL1xuLy8gaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4vL1xuLy8gVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuLy8gZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuLy8gV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4vLyBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4vLyBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cblxuaW1wb3J0IHsgVHJhY2VTcGFuIH0gZnJvbSAnLi4vdHlwZXMvdHJhY2UnO1xuXG5pbXBvcnQgdHJhY2VHZW5lcmF0b3IgZnJvbSAnLi4vZGVtby90cmFjZS1nZW5lcmF0b3JzJztcblxuaW1wb3J0IHtcbiAgZmluZFNlcnZlckNoaWxkU3BhbixcbiAgY3JlYXRlVmlld2VkQm91bmRzRnVuYyxcbiAgaXNDbGllbnRTcGFuLFxuICBpc0Vycm9yU3BhbixcbiAgaXNTZXJ2ZXJTcGFuLFxuICBzcGFuQ29udGFpbnNFcnJlZFNwYW4sXG4gIHNwYW5IYXNUYWcsXG59IGZyb20gJy4vdXRpbHMnO1xuXG5kZXNjcmliZSgnVHJhY2VUaW1lbGluZVZpZXdlci91dGlscycsICgpID0+IHtcbiAgZGVzY3JpYmUoJ2dldFZpZXdlZEJvdW5kcygpJywgKCkgPT4ge1xuICAgIGl0KCd3b3JrcyBmb3IgdGhlIGZ1bGwgcmFuZ2UnLCAoKSA9PiB7XG4gICAgICBjb25zdCBhcmdzID0geyBtaW46IDEsIG1heDogMiwgdmlld1N0YXJ0OiAwLCB2aWV3RW5kOiAxIH07XG4gICAgICBjb25zdCB7IHN0YXJ0LCBlbmQgfSA9IGNyZWF0ZVZpZXdlZEJvdW5kc0Z1bmMoYXJncykoMSwgMik7XG4gICAgICBleHBlY3Qoc3RhcnQpLnRvQmUoMCk7XG4gICAgICBleHBlY3QoZW5kKS50b0JlKDEpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3dvcmtzIGZvciBhIHN1Yi1yYW5nZSB3aXRoIGEgZnVsbCB2aWV3JywgKCkgPT4ge1xuICAgICAgY29uc3QgYXJncyA9IHsgbWluOiAxLCBtYXg6IDIsIHZpZXdTdGFydDogMCwgdmlld0VuZDogMSB9O1xuICAgICAgY29uc3QgeyBzdGFydCwgZW5kIH0gPSBjcmVhdGVWaWV3ZWRCb3VuZHNGdW5jKGFyZ3MpKDEuMjUsIDEuNzUpO1xuICAgICAgZXhwZWN0KHN0YXJ0KS50b0JlKDAuMjUpO1xuICAgICAgZXhwZWN0KGVuZCkudG9CZSgwLjc1KTtcbiAgICB9KTtcblxuICAgIGl0KCd3b3JrcyBmb3IgYSBzdWItcmFuZ2UgdGhhdCBmaWxscyB0aGUgdmlldycsICgpID0+IHtcbiAgICAgIGNvbnN0IGFyZ3MgPSB7IG1pbjogMSwgbWF4OiAyLCB2aWV3U3RhcnQ6IDAuMjUsIHZpZXdFbmQ6IDAuNzUgfTtcbiAgICAgIGNvbnN0IHsgc3RhcnQsIGVuZCB9ID0gY3JlYXRlVmlld2VkQm91bmRzRnVuYyhhcmdzKSgxLjI1LCAxLjc1KTtcbiAgICAgIGV4cGVjdChzdGFydCkudG9CZSgwKTtcbiAgICAgIGV4cGVjdChlbmQpLnRvQmUoMSk7XG4gICAgfSk7XG5cbiAgICBpdCgnd29ya3MgZm9yIGEgc3ViLXJhbmdlIHRoYXQgd2l0aGluIGEgc3ViLXZpZXcnLCAoKSA9PiB7XG4gICAgICBjb25zdCBhcmdzID0geyBtaW46IDEwMCwgbWF4OiAyMDAsIHZpZXdTdGFydDogMC4xLCB2aWV3RW5kOiAwLjkgfTtcbiAgICAgIGNvbnN0IHsgc3RhcnQsIGVuZCB9ID0gY3JlYXRlVmlld2VkQm91bmRzRnVuYyhhcmdzKSgxMzAsIDE3MCk7XG4gICAgICBleHBlY3Qoc3RhcnQpLnRvQmUoMC4yNSk7XG4gICAgICBleHBlY3QoZW5kKS50b0JlKDAuNzUpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnc3Bhbkhhc1RhZygpIGFuZCB2YXJpYW50cycsICgpID0+IHtcbiAgICBpdCgncmV0dXJucyB0cnVlIGlmZiB0aGUga2V5L3ZhbHVlIHBhaXIgaXMgZm91bmQnLCAoKSA9PiB7XG4gICAgICBjb25zdCBzcGFuID0gdHJhY2VHZW5lcmF0b3Iuc3BhbjtcbiAgICAgIHNwYW4udGFncyA9IFt7IGtleTogJ3NwYW4ua2luZCcsIHZhbHVlOiAnc2VydmVyJyB9XTtcbiAgICAgIGV4cGVjdChzcGFuSGFzVGFnKCdzcGFuLmtpbmQnLCAnY2xpZW50Jywgc3BhbikpLnRvQmUoZmFsc2UpO1xuICAgICAgZXhwZWN0KHNwYW5IYXNUYWcoJ3NwYW4ua2luZCcsICdjbGllbnQnLCBzcGFuKSkudG9CZShmYWxzZSk7XG4gICAgICBleHBlY3Qoc3Bhbkhhc1RhZygnc3Bhbi5raW5kJywgJ3NlcnZlcicsIHNwYW4pKS50b0JlKHRydWUpO1xuICAgIH0pO1xuXG4gICAgY29uc3Qgc3BhblR5cGVUZXN0Q2FzZXMgPSBbXG4gICAgICB7IGZuOiBpc0NsaWVudFNwYW4sIG5hbWU6ICdpc0NsaWVudFNwYW4nLCBrZXk6ICdzcGFuLmtpbmQnLCB2YWx1ZTogJ2NsaWVudCcgfSxcbiAgICAgIHsgZm46IGlzU2VydmVyU3BhbiwgbmFtZTogJ2lzU2VydmVyU3BhbicsIGtleTogJ3NwYW4ua2luZCcsIHZhbHVlOiAnc2VydmVyJyB9LFxuICAgICAgeyBmbjogaXNFcnJvclNwYW4sIG5hbWU6ICdpc0Vycm9yU3BhbicsIGtleTogJ2Vycm9yJywgdmFsdWU6IHRydWUgfSxcbiAgICAgIHsgZm46IGlzRXJyb3JTcGFuLCBuYW1lOiAnaXNFcnJvclNwYW4nLCBrZXk6ICdlcnJvcicsIHZhbHVlOiAndHJ1ZScgfSxcbiAgICBdO1xuXG4gICAgc3BhblR5cGVUZXN0Q2FzZXMuZm9yRWFjaCgodGVzdENhc2UpID0+IHtcbiAgICAgIGNvbnN0IG1zZyA9IGAke3Rlc3RDYXNlLm5hbWV9KCkgaXMgdHJ1ZSBvbmx5IHdoZW4gYSAke3Rlc3RDYXNlLmtleX09JHt0ZXN0Q2FzZS52YWx1ZX0gdGFnIGlzIHByZXNlbnRgO1xuICAgICAgaXQobXNnLCAoKSA9PiB7XG4gICAgICAgIGNvbnN0IHNwYW4gPSB7IHRhZ3M6IHRyYWNlR2VuZXJhdG9yLnRhZ3MoKSB9IGFzIFRyYWNlU3BhbjtcbiAgICAgICAgZXhwZWN0KHRlc3RDYXNlLmZuKHNwYW4pKS50b0JlKGZhbHNlKTtcbiAgICAgICAgc3Bhbi50YWdzLnB1c2godGVzdENhc2UpO1xuICAgICAgICBleHBlY3QodGVzdENhc2UuZm4oc3BhbikpLnRvQmUodHJ1ZSk7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ3NwYW5Db250YWluc0VycmVkU3BhbigpJywgKCkgPT4ge1xuICAgIGl0KCdyZXR1cm5zIHRydWUgb25seSB3aGVuIGEgZGVzY2VuZGFudCBoYXMgYW4gZXJyb3IgdGFnJywgKCkgPT4ge1xuICAgICAgY29uc3QgZXJyb3JUYWcgPSB7IGtleTogJ2Vycm9yJywgdHlwZTogJ2Jvb2wnLCB2YWx1ZTogdHJ1ZSB9O1xuICAgICAgY29uc3QgZ2V0VGFncyA9ICh3aXRoRXJyb3I6IG51bWJlcikgPT5cbiAgICAgICAgd2l0aEVycm9yID8gdHJhY2VHZW5lcmF0b3IudGFncygpLmNvbmNhdChlcnJvclRhZykgOiB0cmFjZUdlbmVyYXRvci50YWdzKCk7XG5cbiAgICAgIC8vIFVzaW5nIGEgc3RyaW5nIHRvIGdlbmVyYXRlIHRoZSB0ZXN0IHNwYW5zLiBFYWNoIGxpbmUgcmVzdWx0cyBpbiBhIHNwYW4uIFRoZVxuICAgICAgLy8gbGVmdCBudW1iZXIgaW5kaWNhdGVzIHdoZXRoZXIgb3Igbm90IHRoZSBnZW5lcmF0ZWQgc3BhbiBoYXMgYSBkZXNjZW5kYW50XG4gICAgICAvLyB3aXRoIGFuIGVycm9yIHRhZyAodGhlIGV4cGVjdGF0aW9uKS4gVGhlIGxlbmd0aCBvZiB0aGUgbGluZSBpbmRpY2F0ZXMgdGhlXG4gICAgICAvLyBkZXB0aCBvZiB0aGUgc3BhbiAoaS5lLiBmdXJ0aGVyIHJpZ2h0IGlzIGhpZ2hlciBkZXB0aCkuIFRoZSByaWdodCBudW1iZXJcbiAgICAgIC8vIGluZGljYXRlcyB3aGV0aGVyIG9yIG5vdCB0aGUgc3BhbiBoYXMgYW4gZXJyb3IgdGFnLlxuICAgICAgY29uc3QgY29uZmlnID0gYFxuICAgICAgICAxICAgMFxuICAgICAgICAxICAgICAwXG4gICAgICAgIDAgICAgICAgMVxuICAgICAgICAwICAgICAwXG4gICAgICAgIDEgICAgIDBcbiAgICAgICAgMSAgICAgICAxXG4gICAgICAgIDAgICAgICAgICAxXG4gICAgICAgIDAgICAgICAgICAgIDBcbiAgICAgICAgMSAgICAgICAgIDBcbiAgICAgICAgMCAgICAgICAgICAgMVxuICAgICAgICAwICAgMFxuICAgICAgYFxuICAgICAgICAudHJpbSgpXG4gICAgICAgIC5zcGxpdCgnXFxuJylcbiAgICAgICAgLm1hcCgocykgPT4gcy50cmltKCkpO1xuICAgICAgLy8gR2V0IHRoZSBleHBlY3RhdGlvbiwgc3RyIC0+IG51bWJlciAtPiBib29sXG4gICAgICBjb25zdCBleHBlY3RhdGlvbnMgPSBjb25maWcubWFwKChzKSA9PiBCb29sZWFuKE51bWJlcihzWzBdKSkpO1xuICAgICAgY29uc3Qgc3BhbnMgPSBjb25maWcubWFwKChsaW5lKSA9PiAoe1xuICAgICAgICBkZXB0aDogbGluZS5sZW5ndGgsXG4gICAgICAgIHRhZ3M6IGdldFRhZ3MoK2xpbmUuc2xpY2UoLTEpKSxcbiAgICAgIH0pKSBhcyBUcmFjZVNwYW5bXTtcblxuICAgICAgZXhwZWN0YXRpb25zLmZvckVhY2goKHRhcmdldCwgaSkgPT4ge1xuICAgICAgICAvLyBpbmNsdWRlIHRoZSBpbmRleCBpbiB0aGUgZXhwZWN0IGNvbmRpdGlvbiB0byBrbm93IHdoaWNoIHNwYW4gZmFpbGVkXG4gICAgICAgIC8vIChpZiB0aGVyZSBpcyBhIGZhaWx1cmUsIHRoYXQgaXMpXG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IFtpLCBzcGFuQ29udGFpbnNFcnJlZFNwYW4oc3BhbnMsIGkpXTtcbiAgICAgICAgZXhwZWN0KHJlc3VsdCkudG9FcXVhbChbaSwgdGFyZ2V0XSk7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ2ZpbmRTZXJ2ZXJDaGlsZFNwYW4oKScsICgpID0+IHtcbiAgICBsZXQgc3BhbnM6IFRyYWNlU3BhbltdO1xuXG4gICAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgICBzcGFucyA9IFtcbiAgICAgICAgeyBkZXB0aDogMCwgdGFnczogW3sga2V5OiAnc3Bhbi5raW5kJywgdmFsdWU6ICdjbGllbnQnIH1dIH0sXG4gICAgICAgIHsgZGVwdGg6IDEsIHRhZ3M6IFtdIH0sXG4gICAgICAgIHsgZGVwdGg6IDEsIHRhZ3M6IFt7IGtleTogJ3NwYW4ua2luZCcsIHZhbHVlOiAnc2VydmVyJyB9XSB9LFxuICAgICAgICB7IGRlcHRoOiAxLCB0YWdzOiBbeyBrZXk6ICdzcGFuLmtpbmQnLCB2YWx1ZTogJ3RoaXJkLWtpbmQnIH1dIH0sXG4gICAgICAgIHsgZGVwdGg6IDEsIHRhZ3M6IFt7IGtleTogJ3NwYW4ua2luZCcsIHZhbHVlOiAnc2VydmVyJyB9XSB9LFxuICAgICAgXSBhcyBUcmFjZVNwYW5bXTtcbiAgICB9KTtcblxuICAgIGl0KCdyZXR1cm5zIGZhbHN5IGlmIHRoZSBmcmlzdCBzcGFuIGlzIG5vdCBhIGNsaWVudCcsICgpID0+IHtcbiAgICAgIGV4cGVjdChmaW5kU2VydmVyQ2hpbGRTcGFuKHNwYW5zLnNsaWNlKDEpKSkudG9CZUZhbHN5KCk7XG4gICAgfSk7XG5cbiAgICBpdCgncmV0dXJucyB0aGUgZmlyc3Qgc2VydmVyIHNwYW4nLCAoKSA9PiB7XG4gICAgICBjb25zdCBzcGFuID0gZmluZFNlcnZlckNoaWxkU3BhbihzcGFucyk7XG4gICAgICBleHBlY3Qoc3BhbikudG9CZShzcGFuc1syXSk7XG4gICAgfSk7XG5cbiAgICBpdCgnYmFpbHMgd2hlbiBhIG5vbi1jaGlsZC1kZXB0aCBzcGFuIGlzIGVuY291bnRlcmVkJywgKCkgPT4ge1xuICAgICAgc3BhbnNbMV0uZGVwdGgrKztcbiAgICAgIGV4cGVjdChmaW5kU2VydmVyQ2hpbGRTcGFuKHNwYW5zKSkudG9CZUZhbHN5KCk7XG4gICAgICBzcGFuc1sxXS5kZXB0aCA9IHNwYW5zWzBdLmRlcHRoO1xuICAgICAgZXhwZWN0KGZpbmRTZXJ2ZXJDaGlsZFNwYW4oc3BhbnMpKS50b0JlRmFsc3koKTtcbiAgICB9KTtcbiAgfSk7XG59KTtcbiJdLCJtYXBwaW5ncyI6IkFBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBSUEsT0FBT0EsY0FBYyxNQUFNLDBCQUEwQjtBQUVyRCxTQUNFQyxtQkFBbUIsRUFDbkJDLHNCQUFzQixFQUN0QkMsWUFBWSxFQUNaQyxXQUFXLEVBQ1hDLFlBQVksRUFDWkMscUJBQXFCLEVBQ3JCQyxVQUFVLFFBQ0wsU0FBUztBQUVoQkMsUUFBUSxDQUFDLDJCQUEyQixFQUFFLFlBQU07RUFDMUNBLFFBQVEsQ0FBQyxtQkFBbUIsRUFBRSxZQUFNO0lBQ2xDQyxFQUFFLENBQUMsMEJBQTBCLEVBQUUsWUFBTTtNQUNuQyxJQUFNQyxJQUFJLEdBQUc7UUFBRUMsR0FBRyxFQUFFLENBQUM7UUFBRUMsR0FBRyxFQUFFLENBQUM7UUFBRUMsU0FBUyxFQUFFLENBQUM7UUFBRUMsT0FBTyxFQUFFO01BQUUsQ0FBQztNQUN6RCxJQUFBQyxxQkFBQSxHQUF1QmIsc0JBQXNCLENBQUNRLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUM7UUFBakRNLEtBQUssR0FBQUQscUJBQUEsQ0FBTEMsS0FBSztRQUFFQyxHQUFHLEdBQUFGLHFCQUFBLENBQUhF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